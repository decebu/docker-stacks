networks:
  monitoring-internal:
  frontend:
    external: true
  socket-net:
    external: true
    name: traefik_socket-net 

services:
  # ---------------------------------------------------------
  # UPTIME KUMA - Monitoring Dashboard ("The Witness")
  # Zugriff: http://10.10.10.1:3001 (Nur via VPN erreichbar!)
  # ---------------------------------------------------------
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ./kuma_data:/app/data
    #  - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      # WICHTIG: Bindet nur an die VPN IP. Von außen unsichtbar.
      - "10.10.10.1:3001:3001"
    networks:
      - monitoring-internal
      - socket-net
  # ---------------------------------------------------------
  # NTFY - Unified Push Server
  # Zugriff: http://<VPS_PUBLIC_IP>:8089 (Öffentlich für Push)
  # ---------------------------------------------------------
  ntfy:
    image: binwiederhier/ntfy
    container_name: ntfy
    restart: unless-stopped
    command:
      - serve
      - --cache-file=/var/cache/ntfy/cache.db
      # Base URL ist wichtig für iOS Anhänge (Bilder)
      # Ersetze <DEINE_IP> später idealerweise durch eine Domain
      - --base-url=https://notify.server.decebu.com
      # Auth: Wir erlauben erst mal Read-Write zum Testen.
      # Später auf 'deny-all' stellen für Sicherheit!
      - --auth-default-access=deny-all
      - --enable-login=true
      #- --listen-http :9090
    environment:
      - NTFY_BASE_URL=https://notify.server.decebu.com
      - NTFY_AUTH_FILE=/etc/ntfy/user.db
      - NTFY_AUTH_DEFAULT_ACCESS=deny-all
      - NTFY_UPSTREAM_BASE_URL=https://ntfy.sh
    volumes:
      - ./ntfy_data:/var/cache/ntfy
      - ./ntfy_user.db:/etc/ntfy/user.db
    networks:
      - frontend
      - monitoring-internal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ntfy.rule=Host(`notify.server.decebu.com`) || Host(`notify.home.decebu.com`)"
      - "traefik.http.routers.ntfy.entrypoints=websecure"
      - "traefik.http.routers.ntfy.tls.certresolver=cloudflare"
      - "traefik.http.services.ntfy.loadbalancer.server.port=80" # Interner ntfy Port
      - "traefik.docker.network=frontend"

  # ---------------------------------------------------------
  # DOZZLE - Log Viewer
  # Zugriff: http://10.10.10.1:8888 (Nur via VPN erreichbar!)
  # ---------------------------------------------------------
  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    # volumes:
      #- /var/run/docker.sock:/var/run/docker.sock
    environment:  
      - DOZZLE_REMOTE_HOST=tcp://socket-proxy:2375 
      - DOZZLE_FILTER=
      - DOZZLE_NO_ANALYTICS=true
    # Port 8080 nur öffnen, wenn du über VPN (10.10.10.1:8080) zugreifen willst
    ports:
      - "10.10.10.1:8888:8080"
    networks:
      - monitoring-internal
      - socket-net

  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro # WICHTIG: Damit 4 Uhr auch DEINE 4 Uhr ist (Zeitzone)
    environment:
      - DOCKER_API_VERSION=1.45
      - WATCHTOWER_CLEANUP=true
      # Statt Intervall nutzen wir CRON (Sekunde Minute Stunde Tag Monat Wochentag)
      # Hier: Täglich um 04:00:00 Uhr morgens
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - WATCHTOWER_INCLUDE_STOPPED=true
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NTFY_URL}
    networks:
      - monitoring-internal
